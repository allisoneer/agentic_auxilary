# Use bash with strict flags
set shell := ["bash", "-euo", "pipefail", "-c"]

# CI/output mode detection
ci := env("CI", "false")
output_mode := env("OUTPUT_MODE", if ci == "true" { "normal" } else { "minimal" })

# Wrapper path
WRAP := "../tools/cargo-wrap.sh"

# Core packages (workspace has no root Cargo.toml)
PKGS := "-p universal-tool-core -p universal-tool-macros"

default: help

help:
  @echo "universal_tool commands:"
  @echo "  just check      # fmt-check + clippy (warnings are failures)"
  @echo "  just test       # cargo test (counts results)"
  @echo "  just build      # cargo build (warnings are failures)"
  @echo "  just fmt        # cargo fmt --all"
  @echo "  just fmt-check  # cargo fmt --all --check"

fmt:
  cargo fmt --all

fmt-check:
  {{WRAP}} fmt-check --all

check:
  just fmt-check
  {{WRAP}} clippy {{PKGS}} --all-features --all-targets -- -D warnings

test:
  {{WRAP}} test {{PKGS}} --all-features

build:
  {{WRAP}} build {{PKGS}} --all-features
